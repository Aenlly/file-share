# 测试用户删除功能

## 🎯 测试目标

验证删除用户后，重新创建同名用户不会看到旧数据。

## 📋 测试步骤

### 步骤1: 创建测试用户

1. 以管理员身份登录
2. 进入用户管理页面
3. 创建新用户：
   - 用户名: `testuser`
   - 密码: `test123`
   - 角色: `user`

### 步骤2: 创建测试数据

1. 退出管理员，以 `testuser` 登录
2. 创建测试数据：
   - 创建文件夹 "测试文件夹1"
   - 创建文件夹 "测试文件夹2"
   - 在文件夹1中上传3个文件
   - 在文件夹2中上传2个文件
   - 删除1个文件到回收站
   - 创建1个分享链接

3. 记录数据：
   ```
   文件夹数量: 2
   文件数量: 5
   回收站: 1
   分享链接: 1
   ```

### 步骤3: 删除用户

1. 退出 `testuser`，以管理员登录
2. 进入用户管理页面
3. 删除用户 `testuser`
4. 观察响应消息

**预期响应**：
```json
{
  "success": true,
  "message": "用户及其所有数据已删除",
  "details": {
    "shares": 1,
    "recycleBin": 1,
    "files": 5,
    "folders": 2
  }
}
```

### 步骤4: 验证数据已删除

#### 4.1 检查数据库文件

```bash
# 检查文件夹数据
type backend\data\folders.json | findstr "testuser"
# 应该没有结果

# 检查文件数据
type backend\data\files.json | findstr "testuser"
# 应该没有结果

# 检查回收站数据
type backend\data\recycle_bin.json | findstr "testuser"
# 应该没有结果

# 检查分享数据
type backend\data\shares.json | findstr "testuser"
# 应该没有结果
```

#### 4.2 检查物理文件

```bash
# 检查用户目录
dir files\testuser
# 应该显示 "找不到文件"
```

### 步骤5: 重新创建同名用户

1. 以管理员身份登录
2. 创建新用户：
   - 用户名: `testuser` (相同的用户名)
   - 密码: `newpass123` (不同的密码)
   - 角色: `user`

### 步骤6: 验证新用户数据隔离

1. 以新的 `testuser` 登录（密码: `newpass123`）
2. 检查文件夹列表

**预期结果**：
- ✅ 文件夹列表为空
- ✅ 看不到任何旧数据
- ✅ 回收站为空
- ✅ 没有分享链接

### 步骤7: 创建新数据验证

1. 创建新文件夹 "新文件夹"
2. 上传新文件
3. 确认可以正常使用

## ✅ 测试通过标准

- [ ] 删除用户时返回正确的统计信息
- [ ] 数据库中没有旧用户的数据
- [ ] 物理文件目录已删除
- [ ] 新用户看不到旧数据
- [ ] 新用户可以正常创建数据
- [ ] 日志中有详细的删除记录

## 📊 测试结果记录

### 删除前数据统计
```
用户名: testuser
文件夹: ___ 个
文件: ___ 个
回收站: ___ 个
分享: ___ 个
```

### 删除响应
```json
{
  "success": ___,
  "message": "___",
  "details": {
    "shares": ___,
    "recycleBin": ___,
    "files": ___,
    "folders": ___
  }
}
```

### 删除后验证
- [ ] 数据库已清理
- [ ] 物理文件已删除
- [ ] 新用户数据隔离

## 🔍 查看删除日志

```bash
# 查看删除日志
type backend\logs\combined.log | findstr "删除用户"

# 应该看到类似的日志：
# [2025-12-03 18:00:00] info: 开始删除用户及其所有数据: testuser
# [2025-12-03 18:00:00] info: 删除分享链接: 1 个
# [2025-12-03 18:00:01] info: 删除回收站数据: 1 个
# [2025-12-03 18:00:01] info: 删除文件记录: 5 个
# [2025-12-03 18:00:02] info: 删除文件夹: 2 个
# [2025-12-03 18:00:02] info: 删除用户根目录: files/testuser
# [2025-12-03 18:00:02] info: 删除用户完成: testuser
```

## 🐛 常见问题

### Q1: 删除用户后仍能看到数据？

**检查**：
1. 确认已重启后端服务
2. 清除浏览器缓存
3. 检查数据库文件是否真的删除了

### Q2: 删除失败？

**检查日志**：
```bash
type backend\logs\error.log
```

可能原因：
- 文件被占用
- 权限不足
- 磁盘空间不足

### Q3: 部分数据未删除？

**查看日志**：
```bash
type backend\logs\combined.log | findstr "删除.*失败"
```

手动清理：
```bash
# 删除物理文件
rmdir /s /q files\testuser

# 手动编辑数据库文件删除相关记录
```

## 📝 测试报告模板

```
测试日期: ___________
测试人员: ___________

测试结果: [ ] 通过  [ ] 失败

问题描述:
___________________________________________
___________________________________________

建议:
___________________________________________
___________________________________________
```

## 🚀 自动化测试（可选）

创建测试脚本 `test-user-delete.js`：

```javascript
// TODO: 实现自动化测试
// 1. 创建测试用户
// 2. 创建测试数据
// 3. 删除用户
// 4. 验证数据已清理
// 5. 重新创建同名用户
// 6. 验证数据隔离
```

## ✨ 测试完成

如果所有测试通过，说明用户删除功能正常工作，数据隔离问题已解决！
