# 全局仪表盘功能说明

## 功能概述

为管理员添加了全局统计功能，可以查看所有用户的数据汇总，同时保留了个人统计功能供所有用户使用。

## 功能特性

### 管理员视图

管理员登录后，仪表盘显示两个标签页：

#### 1. 全局统计
显示整个系统的汇总数据：
- **总用户数** - 系统中的用户总数（点击可跳转到用户管理）
- **总文件夹** - 所有用户的文件夹总数
- **总文件** - 所有用户的文件总数
- **总存储空间** - 所有文件占用的总空间
- **总分享链接** - 所有分享链接总数（点击可跳转到分享管理）
- **活跃分享** - 未过期的分享链接数量

**用户详细统计表格**：
- 显示每个用户的详细数据
- 包含：用户ID、用户名、角色、文件夹数、文件数、存储空间、分享数、回收站数
- 支持分页显示
- 支持横向滚动（移动端友好）

#### 2. 我的统计
显示管理员自己的个人数据（与普通用户视图相同）

### 普通用户视图

普通用户登录后，仪表盘只显示个人统计：
- **文件夹** - 我的文件夹数量（点击可跳转）
- **文件** - 我的文件数量
- **存储空间** - 我使用的存储空间
- **回收站** - 我的回收站文件数（点击可跳转）
- **分享链接** - 我的分享链接数（点击可跳转）
- **活跃分享** - 我的未过期分享数（点击可跳转）

## 技术实现

### 前端修改

**文件**: `frontend/src/pages/Dashboard.jsx`

#### 主要变更
1. 添加了 `Tabs` 组件用于切换视图
2. 添加了 `Table` 组件显示用户列表
3. 根据用户角色显示不同内容
4. 提取了 `PersonalStats` 组件复用个人统计逻辑

#### 新增查询
```javascript
// 全局统计查询（仅管理员）
const { data: globalStats, isLoading: globalLoading } = useQuery(
  'globalStats',
  async () => {
    const response = await api.get('/users/stats-all')
    return response.data
  },
  {
    enabled: isAdmin,
    refetchInterval: 60000
  }
)
```

### 后端支持

**文件**: `backend/src/routes/userRoutes.js`

已有的API端点：
- `GET /api/users/stats` - 获取当前用户统计
- `GET /api/users/stats-all` - 获取全局统计（需要管理员权限）

数据格式：
```javascript
{
  users: [
    {
      userId: 1,
      username: "admin",
      role: "admin",
      folders: 5,
      files: 20,
      totalSize: 1048576,
      shares: 3,
      activeShares: 2,
      recycleBin: 1
    },
    // ...
  ],
  totals: {
    totalUsers: 10,
    totalFolders: 50,
    totalFiles: 200,
    totalSize: 10485760,
    totalShares: 30,
    totalActiveShares: 20
  }
}
```

## 使用说明

### 管理员使用

1. 登录管理员账号
2. 点击左侧菜单"仪表盘"
3. 默认显示"全局统计"标签页
4. 查看系统整体数据和用户详细列表
5. 点击"我的统计"标签页查看个人数据

### 普通用户使用

1. 登录普通用户账号
2. 点击左侧菜单"仪表盘"
3. 查看个人数据统计
4. 点击卡片可快速跳转到对应功能

## 权限控制

- **全局统计**: 仅管理员可见
- **个人统计**: 所有用户可见
- **API权限**: `/users/stats-all` 需要 `DASHBOARD_VIEW_ALL` 权限

## 数据刷新

- **个人统计**: 每30秒自动刷新
- **全局统计**: 每60秒自动刷新
- 切换标签页时不会重新加载数据（使用缓存）

## 移动端适配

- 统计卡片响应式布局
- 表格支持横向滚动
- 简化的快捷操作提示
- 优化的间距和字体大小

## 性能优化

1. **按需加载**: 普通用户不会请求全局统计数据
2. **数据缓存**: 使用 React Query 缓存数据
3. **自动刷新**: 定时更新数据，无需手动刷新
4. **分页显示**: 用户列表支持分页，避免一次加载过多数据

## 测试清单

- [ ] 管理员登录，查看全局统计
- [ ] 管理员查看用户详细列表
- [ ] 管理员切换到"我的统计"标签
- [ ] 普通用户登录，只看到个人统计
- [ ] 点击卡片跳转功能正常
- [ ] 数据自动刷新正常
- [ ] 移动端显示正常
- [ ] 表格横向滚动正常

## 未来扩展

可以考虑添加：
1. 数据图表（折线图、饼图等）
2. 时间范围筛选
3. 数据导出功能
4. 用户活跃度分析
5. 存储空间趋势分析
6. 实时数据推送

## 相关文件

- `frontend/src/pages/Dashboard.jsx` - 仪表盘页面
- `backend/src/routes/userRoutes.js` - 用户统计API
- `backend/src/config/permissions.js` - 权限配置

---

**更新日期**: 2024-12-04  
**版本**: v2.1.0  
**状态**: ✅ 已完成
