# 部署检查清单 v2.1.0

## 部署前检查

### 1. 代码验证 ✅
- [x] 所有新文件已创建
- [x] 语法检查通过
- [x] 没有编译错误
- [x] 依赖项完整

### 2. 数据库备份 ⚠️
- [ ] 备份 `data/db.json`（JSON模式）
- [ ] 备份数据库（如使用MySQL/PostgreSQL）
- [ ] 验证备份文件完整性
- [ ] 记录备份时间和位置

### 3. 代码备份 ⚠️
- [ ] 创建Git分支或标签
- [ ] 备份关键文件
- [ ] 记录当前版本号

## 部署步骤

### 阶段1: 角色管理系统部署

#### 步骤1: 停止服务
```bash
# 停止后端服务
# Ctrl+C 或 kill process
```
- [ ] 后端服务已停止
- [ ] 前端服务已停止（如果需要）

#### 步骤2: 更新代码
```bash
git pull origin main
# 或手动复制文件
```
- [ ] 代码已更新
- [ ] 新文件已就位

#### 步骤3: 安装依赖
```bash
cd backend && npm install
cd ../frontend && npm install
```
- [ ] 后端依赖已安装
- [ ] 前端依赖已安装

#### 步骤4: 数据迁移
```bash
cd backend
node scripts/migrate-to-role-system.js
```
- [ ] 迁移脚本执行成功
- [ ] 默认角色已创建
- [ ] 用户已关联到角色
- [ ] 没有错误信息

#### 步骤5: 启动服务
```bash
cd backend
npm start
```
- [ ] 后端服务启动成功
- [ ] 没有启动错误
- [ ] 端口监听正常

#### 步骤6: 功能测试
- [ ] 登录系统
- [ ] 访问"角色管理"页面
- [ ] 查看默认角色
- [ ] 创建测试角色
- [ ] 为用户分配角色
- [ ] 验证权限生效

### 阶段2: 路由重构部署

#### 步骤1: 执行迁移
```bash
# Windows
migrate-routes.bat

# Linux/Mac
chmod +x migrate-routes.sh
./migrate-routes.sh
```
- [ ] 原文件已备份
- [ ] 新文件已验证
- [ ] 文件替换成功
- [ ] 语法检查通过

#### 步骤2: 重启服务
```bash
cd backend
npm start
```
- [ ] 服务重启成功
- [ ] 没有模块加载错误
- [ ] 路由注册正常

#### 步骤3: 功能测试
- [ ] 文件夹列表加载
- [ ] 文件上传功能
- [ ] 文件下载功能
- [ ] 文件删除功能
- [ ] 文件移动功能
- [ ] 图片预览功能
- [ ] 分片上传功能

## 部署后验证

### 1. 基础功能测试
- [ ] 用户登录
- [ ] 文件夹管理
- [ ] 文件上传
- [ ] 文件下载
- [ ] 文件删除
- [ ] 回收站功能

### 2. 角色管理测试
- [ ] 查看角色列表
- [ ] 创建角色
- [ ] 编辑角色
- [ ] 删除角色
- [ ] 分配角色
- [ ] 权限验证

### 3. 性能测试
- [ ] 页面加载速度正常
- [ ] 文件上传速度正常
- [ ] 图片预览速度正常
- [ ] 并发请求处理正常

### 4. 错误处理测试
- [ ] 权限拒绝提示正确
- [ ] 文件不存在提示正确
- [ ] 网络错误处理正常
- [ ] 异常情况恢复正常

## 监控指标

### 1. 系统指标
- [ ] CPU使用率 < 80%
- [ ] 内存使用率 < 80%
- [ ] 磁盘空间充足
- [ ] 网络连接正常

### 2. 应用指标
- [ ] 响应时间 < 2秒
- [ ] 错误率 < 1%
- [ ] 并发用户数正常
- [ ] 数据库连接正常

### 3. 日志检查
- [ ] 没有ERROR级别日志
- [ ] WARN日志在可接受范围
- [ ] 关键操作有日志记录
- [ ] 日志格式正确

## 回滚计划

### 如果角色管理系统出现问题

#### 方案A: 数据回滚
```bash
# 1. 停止服务
# 2. 恢复数据库备份
cp data/db.json.backup data/db.json
# 3. 回滚代码
git checkout <previous-commit>
# 4. 重启服务
```

#### 方案B: 代码回滚
```bash
git revert <commit-hash>
npm start
```

### 如果路由重构出现问题

```bash
# 执行回滚脚本
rollback-routes.bat  # Windows
./rollback-routes.sh  # Linux/Mac

# 重启服务
cd backend && npm start
```

## 问题排查

### 常见问题

#### 1. 角色管理页面无法访问
- 检查用户权限
- 检查路由配置
- 查看浏览器控制台错误

#### 2. 用户无法分配角色
- 检查角色是否存在
- 检查用户权限
- 查看后端日志

#### 3. 文件上传失败
- 检查文件大小限制
- 检查磁盘空间
- 查看错误日志

#### 4. 图片预览不显示
- 检查文件路径
- 检查文件权限
- 查看网络请求

### 日志位置
```
backend/logs/app.log
backend/logs/error.log
```

### 联系方式
- 技术支持: [联系方式]
- 紧急联系: [联系方式]

## 部署完成确认

### 签字确认
- [ ] 开发人员: _____________ 日期: _______
- [ ] 测试人员: _____________ 日期: _______
- [ ] 运维人员: _____________ 日期: _______
- [ ] 项目经理: _____________ 日期: _______

### 部署信息
- 部署日期: _________________
- 部署时间: _________________
- 版本号: 2.1.0
- 部署环境: [ ] 开发 [ ] 测试 [ ] 生产
- 部署人员: _________________

### 备注
```
_________________________________________________
_________________________________________________
_________________________________________________
```

---

**重要提示**:
1. 部署前务必备份数据
2. 在测试环境验证后再部署到生产环境
3. 保留回滚方案以备不时之需
4. 部署过程中保持团队沟通
5. 记录所有问题和解决方案
