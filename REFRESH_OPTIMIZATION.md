# 刷新优化和限流修复

## 修复时间：2024-12-04

## 问题描述

1. **限流问题**：限流策略不合理，导致频繁出现 429 错误
2. **自动刷新问题**：Dashboard 页面每 30-60 秒自动刷新，浪费资源
3. **时间显示问题**：文件夹创建时间显示不正确

## 修复内容

### 1. 限流策略优化（类似 Sentinel）

**修改文件**：
- `backend/src/middleware/rateLimiter.js`
- `backend/src/config/index.js`

**修改内容**：
- API 限流：1秒内单个接口最多 5 次请求（原：15分钟100次）
- 登录限流：1分钟内最多 5 次（原：15分钟10次）
- 上传限流：1秒内最多 10 次（原：1小时1000次，支持分片并发）
- 关键改进：使用 `IP + 接口路径` 组合生成 key，实现单个接口独立限流

### 2. 优化自动刷新策略

**修改文件**：
- `frontend/src/pages/Dashboard.jsx`

**修改内容**：
- ✅ **仪表盘保留定时刷新**：个人统计 30 秒，全局统计 60 秒（显示实时数据）
- ✅ **其他管理页面移除定时刷新**：仅在操作后手动刷新（节省资源）

### 3. 修复文件夹时间显示

**修改文件**：
- `frontend/src/pages/FolderManagement.jsx`

**修改内容**：
- 优先使用 `createdAt` 字段显示创建时间
- 兼容旧数据（使用 id 作为时间戳）

### 4. 添加分享后刷新统计

**修改文件**：
- `frontend/src/components/FolderDetail/ShareModal.jsx`

**修改内容**：
- 创建分享后自动刷新用户统计和全局统计

## 刷新机制说明

### 仪表盘（Dashboard）
- ✅ **定时自动刷新**：个人统计每 30 秒，全局统计每 60 秒
- ✅ 显示实时的文件、文件夹、分享等统计数据

### 其他管理页面
所有管理页面采用**操作后刷新**的策略（不定时刷新）：

### 文件夹管理
- ✅ 创建文件夹后刷新列表和统计
- ✅ 删除文件夹后刷新列表和统计

### 文件操作
- ✅ 上传文件后刷新文件列表
- ✅ 删除文件后刷新文件列表
- ✅ 移动文件后刷新文件列表

### 子文件夹
- ✅ 创建子文件夹后刷新子文件夹列表
- ✅ 删除子文件夹后刷新子文件夹列表

### 分享管理
- ✅ 创建分享后刷新统计数据

### 回收站
- ✅ 恢复文件后刷新回收站列表
- ✅ 永久删除后刷新回收站列表
- ✅ 清空回收站后刷新列表

### 用户管理
- ✅ 创建用户后刷新用户列表
- ✅ 更新用户后刷新用户列表
- ✅ 删除用户后刷新用户列表

### 权限管理
- ✅ 更新权限后刷新用户列表

## 技术实现

### React Query 缓存失效
使用 `queryClient.invalidateQueries()` 在操作成功后使缓存失效，触发自动重新获取数据。

### 组件间通信
通过 `onRefresh`、`onSuccess` 等回调函数在父子组件间传递刷新信号。

## 测试建议

1. 测试限流：快速点击同一接口，确认 1 秒内超过 5 次才会被限制
2. 测试刷新：执行各种操作后，确认相关数据自动更新
3. 测试时间显示：创建新文件夹，确认时间显示正确

## 注意事项

- 前端没有限流逻辑，所有限流都在后端控制
- 数据库 insert 操作会自动添加 `createdAt` 和 `updatedAt` 字段
- 修改后需要重启后端服务才能生效
